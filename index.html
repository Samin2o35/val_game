<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Interactive Story</title>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: system-ui, sans-serif;
            background: linear-gradient(#0d0d2b, #000014);
            color: #ffd1dc;
            text-align: center;
        }

        /* Stars */
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite alternate;
        }

        @keyframes twinkle {
            from {
                opacity: .2
            }

            to {
                opacity: 1
            }
        }

        /* Owl */
        .owl {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
        }

        .eye {
            transition: .3s ease;
        }

        /* Characters */
        .character {
            position: absolute;
            bottom: 120px;
            width: 140px;
            opacity: 0;
            transition: opacity .8s ease;
        }

        .boy {
            left: 5%;
        }

        .girl {
            right: 5%;
        }

        .head {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: auto;
            background: #ffe0bd;
        }

        .body {
            width: 80px;
            height: 100px;
            border-radius: 30px;
            margin: auto;
            margin-top: -10px;
            background: #5c8df6;
        }

        .girl .body {
            background: #ff7aa2;
        }

        /* Text Area */

        .speech {
            position: absolute;
            width: 220px;
            min-height: 40px;
            font-size: 16px;
            opacity: 0;
            transition: opacity .3s ease;
        }

        .boySpeech {
            left: 5%;
            bottom: 260px;
            /* ABOVE BOY */
            text-align: left;
        }

        .girlSpeech {
            right: 5%;
            bottom: 260px;
            /* ABOVE GIRL */
            text-align: right;
        }

        .centerSpeech {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            font-size: 20px;
        }

        /* Text Area */
        #text {
            position: absolute;
            bottom: 70px;
            width: 100%;
            padding: 0 20px;
            font-size: 18px;
            min-height: 80px;
        }

        .hint {
            font-size: 13px;
            opacity: .6;
            margin-top: 6px;
        }

        /* Buttons */
        .options {
            position: absolute;
            top: 65%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
        }

        button {
            position: absolute;
            padding: 14px 24px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 999px;
            border: none;
            cursor: pointer;
        }

        #yesBtn {
            left: 20%;
            background: #ff3b7a;
            color: white;
        }

        #noBtn {
            left: 60%;
            background: #e5e7eb;
        }

        /* Confetti canvas */
        #confettiCanvas {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .centerText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
            font-weight: bold;
            display: none;
        }
    </style>
</head>

<body>

    <canvas id="confettiCanvas"></canvas>
    <div class="centerText" id="centerText">Yay! ðŸŽ‰</div>

    <!-- Owl -->
    <div class="owl">
        <svg width="140" height="120">
            <circle cx="70" cy="60" r="50" fill="#c89cff" />
            <circle id="leftEye" cx="50" cy="55" r="10" fill="black" />
            <circle id="rightEye" cx="90" cy="55" r="10" fill="black" />
            <rect id="lidL" x="40" y="45" width="20" height="20" fill="#c89cff" />
            <rect id="lidR" x="80" y="45" width="20" height="20" fill="#c89cff" />
        </svg>
    </div>

    <!-- Characters -->
    <div class="character boy" id="boy">
        <div class="head"></div>
        <div class="body"></div>
    </div>
    <div class="character girl" id="girl">
        <div class="head"></div>
        <div class="body"></div>
    </div>

    <div id="boyText" class="speech boySpeech"></div>
    <div id="girlText" class="speech girlSpeech"></div>
    <div id="centerTextLine" class="centerSpeech"></div>

    <div id="hint" class="hint"></div>
    <div class="options" id="options"></div>

    <script>

        /* Stars */
        for (let i = 0; i < 100; i++) {
            let s = document.createElement("div");
            s.className = "star";
            s.style.left = Math.random() * 100 + "%";
            s.style.top = Math.random() * 100 + "%";
            s.style.animationDelay = Math.random() * 3 + "s";
            document.body.appendChild(s);
        }

        /* Owl control */
        const leftEye = document.getElementById("leftEye");
        const rightEye = document.getElementById("rightEye");
        const lidL = document.getElementById("lidL");
        const lidR = document.getElementById("lidR");

        function openEyes() {
            lidL.style.height = "0";
            lidR.style.height = "0";
        }
        function lookLeft() {
            leftEye.setAttribute("cx", 45);
            rightEye.setAttribute("cx", 85);
        }
        function lookRight() {
            leftEye.setAttribute("cx", 55);
            rightEye.setAttribute("cx", 95);
        }
        function lookDown() {
            leftEye.setAttribute("cy", 60);
            rightEye.setAttribute("cy", 60);
        }

        /* Typewriter */
        const boyText = document.getElementById("boyText");
        const girlText = document.getElementById("girlText");
        const centerTextLine = document.getElementById("centerTextLine");

        const hint = document.getElementById("hint");

        let typing = false;
        let typingInterval = null;
        let currentLine = "";
        let currentIndex = 0;

        function typeLine(line, target, cb) {
            if (typing) return;

            typing = true;
            currentLine = line;
            currentIndex = 0;

            boyText.style.opacity = 0;
            girlText.style.opacity = 0;
            centerTextLine.style.opacity = 0;

            target.innerHTML = "";
            target.style.opacity = 1;

            clearInterval(typingInterval);

            typingInterval = setInterval(() => {
                target.innerHTML += currentLine[currentIndex];
                currentIndex++;

                if (currentIndex >= currentLine.length) {
                    clearInterval(typingInterval);
                    typing = false;
                    if (cb) cb();
                }
            }, 35);
        }

        /* STORY FLOW */
        let stage = 0;

        const dialogue = [
            ["G", "Ty for making my trip so memorable"],
            ["B", "You're welcome"],
            ["B", "But I had a selfish reason for doing all that"],
            ["G", "Like what?"],
            ["B", "...I was curious"],
            ["G", "Huh?"],
            ["B", "I was curious how I felt about you."],
            ["B", "Weather how I feel about you is the current you"],
            ["B", "Or nostalgia for the old you"],
            ["G", "So...what did you find out?"],
            ["B", "Well I'm fairly certain how I feel now."],
            ["B", "It turns out the grade 10 version of you,"],
            ["B", "I had the biggest crush on"],
            ["B", "And the current version of you..."],
            ["B", "I'm head over heels for <3"],
            ["G", "Hmmm....I wonder if I feel the same..."],
            ["G", "...Yes"],
            ["G", "...No"],
            ["G", "...Maybe"],
            ["B", "I'll accept that for now."]
        ];

        const narration = [
            "Things have gotten more complicated since then.",
            "But I'm happy with how the story played out so far",
            "And I hope it has a happy ending In Sha Allah.",
            "Speaking of...I was curious again about sth"
        ];

        document.body.addEventListener("click", next);

        function next() {
            if (stage === 0) {
                openEyes();
                lookDown();
                typeLine("One Faithful Night", centerTextLine, () => {
                    hint.innerText = "Tap to continue";
                    stage = 1;
                });
            }
            else if (stage === 1) {
                hint.innerText = "";
                typeLine("Wayyy past any sane person's bedtime.", centerTextLine, () => {
                    document.getElementById("boy").style.opacity = 1;
                    document.getElementById("girl").style.opacity = 1;
                    stage = 2;
                });
            }
            else if (stage >= 2 && stage < 2 + dialogue.length) {
                let [who, line] = dialogue[stage - 2];
                if (who === "G") lookRight(); else lookLeft();
                if (who === "G") {
                    lookRight();
                    typeLine(line, girlText);
                } else {
                    lookLeft();
                    typeLine(line, boyText);
                }
                stage++;
            }
            else if (stage === 2 + dialogue.length) {
                document.getElementById("boy").style.opacity = 0;
                document.getElementById("girl").style.opacity = 0;
                stage++;
                runNarration(0);
            }
        }

        function runNarration(i) {
            if (i < narration.length) {
                typeLine(narration[i], centerTextLine, () => {
                    document.body.addEventListener("click", function handler() {
                        document.body.removeEventListener("click", handler);
                        runNarration(i + 1);
                    });
                });
            } else {
                showFinalQuestion();
            }
        }

        /* Final Question */
        function showFinalQuestion() {
            typeLine("Will you be my Valentine?", centerTextLine, () => {
                const options = document.getElementById("options");
                options.innerHTML = `
      <button id="yesBtn">Yes</button>
      <button id="noBtn">No</button>
    `;
                const yes = document.getElementById("yesBtn");
                const no = document.getElementById("noBtn");

                let scale = 1;

                function growYes() {
                    scale = Math.min(2.2, scale + 0.1);
                    yes.style.transform = `scale(${scale})`;
                }

                function moveNo(e) {
                    const x = Math.random() * 60 + 20;
                    const y = Math.random() * 60 + 20;
                    no.style.left = x + "%";
                    no.style.top = y + "%";
                    growYes();
                }

                no.addEventListener("pointerenter", moveNo);
                no.addEventListener("touchstart", moveNo);

                yes.addEventListener("click", () => {
                    options.style.display = "none";
                    text.style.display = "none";
                    document.getElementById("centerText").style.display = "block";
                    launchConfetti();
                });
            });
        }

        /* Confetti */
        const confettiCanvas = document.getElementById("confettiCanvas");
        function resizeCanvas() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        const confettiInstance = confetti.create(confettiCanvas, { resize: true, useWorker: true });

        function launchConfetti() {
            const end = Date.now() + 1500;
            (function frame() {
                confettiInstance({
                    particleCount: 12,
                    spread: 90,
                    startVelocity: 45,
                    origin: { x: Math.random(), y: Math.random() * 0.3 }
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            })();
            setTimeout(() => {
                confettiInstance({
                    particleCount: 300,
                    spread: 140,
                    startVelocity: 60,
                    origin: { x: 0.5, y: 0.55 }
                });
            }, 300);
        }

    </script>
</body>

</html>